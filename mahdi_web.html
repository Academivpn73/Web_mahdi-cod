<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>فلوچارت هوشمند</title>
<style>
:root{
  --bg:#041522; --card:#062032; --text:#e6eef8;
  --start:#16a34a; --proc:#0284c7; --dec:#f97316; --end:#7c3aed; --arrow:#9fd6f7;
  --muted:#98a8bd;
}
body{margin:0;padding:16px;font-family:Vazirmatn,sans-serif;background:var(--bg);color:var(--text);}
h2{margin:0 0 8px 0;}
.card{background:var(--card);padding:16px;border-radius:12px;margin-bottom:16px;box-shadow:0 6px 20px rgba(0,0,0,0.5);}
textarea{width:100%;min-height:80px;padding:8px;background:transparent;border:1px solid rgba(255,255,255,0.1);color:inherit;border-radius:8px;font-size:14px;}
button{padding:10px 14px;margin:4px 2px;border:none;border-radius:10px;background:var(--proc);color:white;cursor:pointer;font-size:14px;}
.layout{display:grid;grid-template-columns:1fr 440px;gap:16px;}
.flowcard{height:600px;overflow:auto;padding:12px;}
pre{white-space:pre-wrap;word-break:break-word;color:#cfe9ff;font-size:13px;}
.legend{display:flex;flex-direction:column;gap:6px;font-size:13px;margin-top:10px;}
.item{display:flex;gap:8px;align-items:center;}
.dot{width:18px;height:18px;border-radius:4px;}
.dot.round{border-radius:50%;}
@media(max-width:1100px){.layout{grid-template-columns:1fr;}}
svg{width:100%;height:100%;display:block;}
</style>
</head>
<body>

<div class="card">
<h2>فلوچارت هوشمند</h2>
<p>مسئله خود را وارد کنید، فلوچارت دقیق همراه با توضیح اختصاصی هر گره نمایش داده می‌شود.</p>
<textarea id="problem" placeholder="مثال: اعداد بین 10 تا 30 را تولید کن"></textarea>
<br>
<button id="generate">تولید فلوچارت</button>
<button id="exportSvg">دانلود SVG</button>
<button id="exportPng">دانلود PNG</button>
</div>

<div class="layout">
<div class="card flowcard">
<h3>فلوچارت</h3>
<div id="svgWrap" style="margin-top:12px;height:600px;">
<svg id="flowSvg" viewBox="0 0 900 1200" preserveAspectRatio="xMidYMin meet"></svg>
</div>
<div class="legend">
<div style="font-weight:600">راهنما شکل‌ها</div>
<div class="item"><div class="dot round" style="background:var(--start)"></div> دایره: شروع / پایان</div>
<div class="item"><div class="dot" style="background:var(--proc)"></div> مستطیل: عملیات / محاسبات</div>
<div class="item"><div class="dot" style="background:var(--dec);width:22px;height:22px;transform:rotate(45deg)"></div> لوزی: شرط / تصمیم</div>
<div class="item"><div class="dot" style="background:var(--end)"></div> خروجی / نمایش نتیجه</div>
</div>
</div>

<div class="card flowcard">
<h3>اطلاعات کد</h3>
<div id="info" style="margin-top:12px;color:#cfe9ff"></div>
<hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)">
<h3>شرح هر گره</h3>
<pre id="explain"></pre>
</div>
</div>

<script>
/* ====== تحلیل مسئله ====== */
function analyzeProblem(text){
  text=text.toLowerCase();
  // تولید بازه
  const matchRange=text.match(/اعداد\s+بین\s+(\d+)\s+تا\s+(\d+)/);
  if(matchRange){
    const start=parseInt(matchRange[1]), end=parseInt(matchRange[2]);
    return {type:'range', start, end};
  }
  // سایر نوع الگوریتم‌ها را می‌توان اضافه کرد
  return {type:'generic'};
}

/* ====== ساخت گراف با توضیح اختصاصی ====== */
function buildGraph(problem){
  const analysis=analyzeProblem(problem);
  const nodes=[], edges=[], nid=(i=>()=> 'n'+(i+=1))(0);

  if(analysis.type==='range'){
    const {start,end}=analysis;
    const startId=nid(); nodes.push({id:startId,text:'شروع',type:'start',explain:'شروع اجرای الگوریتم تولید اعداد'});
    const initId=nid(); nodes.push({id:initId,text:`تعیین بازه ${start} تا ${end}`,type:'proc',explain:`تعریف متغیر start=${start} و end=${end} و current=start`});
    const decisionId=nid(); nodes.push({id:decisionId,text:`آیا عدد فعلی ≤ ${end}?`,type:'decision',explain:'بررسی پایان بازه؛ اگر بله ادامه، اگر خیر پایان'});
    const printId=nid(); nodes.push({id:printId,text:`نمایش عدد فعلی`,type:'proc',explain:'چاپ عدد فعلی روی خروجی'});
    const incId=nid(); nodes.push({id:incId,text:`افزایش عدد فعلی`,type:'proc',explain:'current = current + 1'});
    const endId=nid(); nodes.push({id:endId,text:'پایان',type:'end',explain:'پایان الگوریتم'});

    edges.push({from:startId,to:initId});
    edges.push({from:initId,to:decisionId});
    edges.push({from:decisionId,to:printId,label:'بله'});
    edges.push({from:printId,to:incId});
    edges.push({from:incId,to:decisionId});
    edges.push({from:decisionId,to:endId,label:'خیر'});

    return {nodes,edges};
  }

  // حالت generic
  const startId=nid(); nodes.push({id:startId,text:'شروع',type:'start',explain:'شروع اجرای الگوریتم'});
  const procId=nid(); nodes.push({id:procId,text:'پردازش اصلی مسئله',type:'proc',explain:'اجرای الگوریتم مسئله'});
  const endId=nid(); nodes.push({id:endId,text:'پایان',type:'end',explain:'پایان الگوریتم'});
  edges.push({from:startId,to:procId});
  edges.push({from:procId,to:endId});
  return {nodes,edges};
}

/* ====== layout عمودی ====== */
function layoutGraph(graph){
  const positions={};
  let y=60;
  graph.nodes.forEach((n,idx)=>{
    let x=450;
    if(n.type==='decision') x = idx%2===0? 310 : 590;
    positions[n.id]={x,y};
    y+=110;
  });
  return positions;
}

/* ====== render SVG ====== */
function render(graph, positions, svgEl){
  while(svgEl.firstChild) svgEl.removeChild(svgEl);
  const ns='http://www.w3.org/2000/svg';
  const el=(t,a={})=>{const e=document.createElementNS(ns,t);for(const k in a)e.setAttribute(k,a[k]);return e;}
  const defs=el('defs'); svgEl.appendChild(defs);
  const marker=el('marker',{id:'arrow', markerWidth:10, markerHeight:10, refX:8, refY:5, orient:'auto', markerUnits:'strokeWidth'});
  marker.appendChild(el('path',{d:'M0 0 L10 5 L0 10 z',fill:'var(--arrow)'})); defs.appendChild(marker);

  // edges
  graph.edges.forEach(e=>{
    const p1=positions[e.from], p2=positions[e.to];
    const startX=p1.x,startY=p1.y+30,endX=p2.x,endY=p2.y-30,midY=(startY+endY)/2;
    const pathD=`M ${startX} ${startY} C ${startX} ${midY} ${endX} ${midY} ${endX} ${endY}`;
    const pathEl=el('path',{d:pathD,stroke:'var(--arrow)','stroke-width':1.6,fill:'none','marker-end':'url(#arrow)'});
    svgEl.appendChild(pathEl);
    const edge=graph.edges.find(edge=>edge.from===e.from && edge.to===e.to);
    if(edge && edge.label){
      const tEl=el('text',{x:(startX+endX)/2,y:midY-8,'text-anchor':'middle',class:'label-text'});
      tEl.textContent=edge.label;
      svgEl.appendChild(tEl);
    }
  });

  // nodes
  graph.nodes.forEach(n=>{
    const p=positions[n.id]; const g=el('g',{'data-id':n.id});
    if(n.type==='start'){g.appendChild(el('rect',{x:p.x-110,y:p.y-22,width:220,height:44,rx:22,fill:'var(--start)'}));}
    else if(n.type==='end'){g.appendChild(el('rect',{x:p.x-110,y:p.y-22,width:220,height:44,rx:22,fill:'var(--end)'}));}
    else if(n.type==='decision'){const sX=110,sY=34;const pts=`${p.x},${p.y-sY} ${p.x+sX},${p.y} ${p.x},${p.y+sY} ${p.x-sX},${p.y}`;g.appendChild(el('polygon',{points:pts,fill:'var(--dec)'}));}
    else{g.appendChild(el('rect',{x:p.x-140,y:p.y-24,width:280,height:48,rx:8,fill:'var(--proc)'}));}

    const lines=n.text.match(/.{1,28}/g)||[n.text];
    lines.forEach((ln,i)=>{
      const tx=el('text',{x:p.x,y:p.y-((lines.length-1)*8)+i*16,'text-anchor':'middle','class':'node-text'});
      tx.textContent=ln;
      g.appendChild(tx);
    });
    svgEl.appendChild(g);
  });
}

/* ====== UI ====== */
const genBtn=document.getElementById('generate'), problemEl=document.getElementById('problem'),
svgEl=document.getElementById('flowSvg'), infoEl=document.getElementById('info'), explainEl=document.getElementById('explain');

genBtn.addEventListener('click',()=>{
  const problem=problemEl.value.trim(); if(!problem){alert('لطفاً مسئله را وارد کنید'); return;}
  const graph=buildGraph(problem);
  const pos=layoutGraph(graph);
  render(graph,pos,svgEl);

  // info
  infoEl.innerHTML=`<strong>ورودی‌ها:</strong> براساس مسئله وارد شده<br>
  <strong>متغیرها:</strong> متغیرهای داخلی الگوریتم<br>
  <strong>پیچیدگی:</strong> بستگی به الگوریتم`;

  // توضیح اختصاصی گره‌ها
  const expl=graph.nodes.map(n=>`- [${n.id}] "${n.text}"\n  توضیح: ${n.explain}`).join('\n\n');
  explainEl.textContent=expl;
});

/* ====== Export SVG/PNG ====== */
document.getElementById('exportSvg').addEventListener('click',()=>{
  const serializer=new XMLSerializer(); const str=serializer.serializeToString(svgEl);
  const blob=new Blob([str],{type:'image/svg+xml'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='flowchart.svg'; document.body.appendChild(a);a.click();a.remove();
});
document.getElementById('exportPng').addEventListener('click',()=>{
  const serializer=new XMLSerializer(); const str=serializer.serializeToString(svgEl); const img=new Image();
  const svgBlob=new Blob([str],{type:'image/svg+xml'}); const url=URL.createObjectURL(svgBlob);
  img.onload=function(){const canvas=document.createElement('canvas');canvas.width=900;canvas.height=1200;
  const ctx=canvas.getContext('2d'); ctx.fillStyle='#02121a'; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height);
  canvas.toBlob(function(blob){const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='flowchart.png';document.body.appendChild(a);a.click();a.remove();},'image/png'); URL.revokeObjectURL(url);};
  img.src=url;
});
</script>

</body>
</html>
