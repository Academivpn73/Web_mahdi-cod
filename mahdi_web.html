<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>فلوچارت حرفه‌ای هوشمند</title>
<style>
:root{
  --bg:#041522; --card:#062032; --text:#e6eef8;
  --start:#16a34a; --proc:#0284c7; --dec:#f97316; --end:#7c3aed; --arrow:#9fd6f7;
}
body{margin:0;padding:16px;font-family:Vazirmatn,sans-serif;background:var(--bg);color:var(--text);}
h2,h3{margin:0 0 8px 0;}
.card{background:var(--card);padding:16px;border-radius:12px;margin-bottom:16px;box-shadow:0 6px 20px rgba(0,0,0,0.5);}
textarea{width:100%;min-height:80px;padding:8px;background:transparent;border:1px solid rgba(255,255,255,0.1);color:inherit;border-radius:8px;font-size:14px;}
button{padding:10px 14px;margin:4px 2px;border:none;border-radius:10px;background:var(--proc);color:white;cursor:pointer;font-size:14px;}
.layout{display:grid;grid-template-columns:1fr 480px;gap:16px;}
.flowcard{height:600px;overflow:auto;padding:12px;}
pre{white-space:pre-wrap;word-break:break-word;color:#cfe9ff;font-size:13px;}
.legend{display:flex;flex-direction:column;gap:6px;font-size:13px;margin-top:10px;}
.item{display:flex;gap:8px;align-items:center;}
.dot{width:18px;height:18px;border-radius:4px;}
.dot.round{border-radius:50%;}
@media(max-width:1100px){.layout{grid-template-columns:1fr;}}
svg{width:100%;height:100%;display:block;}
.code-box{background:#02121a;padding:8px;border-radius:6px;font-family:monospace;margin-top:4px;font-size:13px;}
</style>
</head>
<body>

<div class="card">
<h2>فلوچارت حرفه‌ای هوشمند</h2>
<p>مسئله خود را وارد کنید، الگوریتم بهینه به همراه فلوچارت و کد هر گره نمایش داده می‌شود.</p>
<textarea id="problem" placeholder="مثال: اعداد بین 10 تا 30 را تولید کن"></textarea>
<br>
<button id="generate">تولید فلوچارت</button>
<button id="exportSvg">دانلود SVG</button>
<button id="exportPng">دانلود PNG</button>
</div>

<div class="layout">
<div class="card flowcard">
<h3>فلوچارت</h3>
<div id="svgWrap" style="margin-top:12px;height:600px;">
<svg id="flowSvg" viewBox="0 0 900 1200" preserveAspectRatio="xMidYMin meet"></svg>
</div>
<div class="legend">
<div style="font-weight:600">راهنما شکل‌ها</div>
<div class="item"><div class="dot round" style="background:var(--start)"></div> دایره: شروع / پایان</div>
<div class="item"><div class="dot" style="background:var(--proc)"></div> مستطیل: عملیات / محاسبات</div>
<div class="item"><div class="dot" style="background:var(--dec);width:22px;height:22px;transform:rotate(45deg)"></div> لوزی: شرط / تصمیم</div>
<div class="item"><div class="dot" style="background:var(--end)"></div> خروجی / نمایش نتیجه</div>
</div>
</div>

<div class="card flowcard">
<h3>شرح گره‌ها و کد</h3>
<pre id="explain"></pre>
</div>
</div>

<script>
/* ====== تحلیل هوشمند مسئله ====== */
function analyzeProblem(text){
  text=text.toLowerCase();

  // تولید بازه
  const matchRange=text.match(/اعداد\s+بین\s+(\d+)\s+تا\s+(\d+)/);
  if(matchRange){
    return {type:'range', start:parseInt(matchRange[1]), end:parseInt(matchRange[2])};
  }

  // جمع اعداد
  const matchSum=text.match(/جمع\s+اعداد\s+از\s+(\d+)\s+تا\s+(\d+)/);
  if(matchSum) return {type:'sum', start:parseInt(matchSum[1]), end:parseInt(matchSum[2])};

  // بزرگترین عدد
  if(text.includes("بزرگترین عدد") || text.includes("max")) return {type:'max'};

  // فاکتوریل
  if(text.includes("فاکتوریل")) return {type:'factorial'};

  return {type:'generic'};
}

/* ====== ساخت گراف با کد و توضیح اختصاصی ====== */
function buildGraph(problem){
  const analysis=analyzeProblem(problem);
  const nodes=[], edges=[], nid=(i=>()=> 'n'+(i+=1))(0);

  function addNode(text,type,explain,code){const id=nid();nodes.push({id,text,type,explain,code});return id;}

  // انواع الگوریتم
  if(analysis.type==='range'){
    const startId=addNode('شروع','start','شروع الگوریتم','');
    const initId=addNode(`تعیین بازه ${analysis.start} تا ${analysis.end}`,'proc','تعریف متغیرهای start,end,current',`start=${analysis.start}; end=${analysis.end}; current=start;`);
    const decisionId=addNode(`آیا عدد فعلی ≤ ${analysis.end}?`,'decision','بررسی پایان بازه',`current <= end`);
    const printId=addNode('نمایش عدد فعلی','proc','چاپ عدد فعلی',`print(current);`);
    const incId=addNode('افزایش عدد فعلی','proc','افزایش عدد برای حلقه','current += 1;');
    const endId=addNode('پایان','end','پایان الگوریتم','');

    edges.push({from:startId,to:initId},{from:initId,to:decisionId},{from:decisionId,to:printId,label:'بله'},
               {from:printId,to:incId},{from:incId,to:decisionId},{from:decisionId,to:endId,label:'خیر'});
    return {nodes,edges};
  }

  if(analysis.type==='sum'){
    const startId=addNode('شروع','start','شروع الگوریتم جمع اعداد','');
    const initId=addNode('مقداردهی اولیه','proc','تعریف sum و current',`sum=0; current=${analysis.start};`);
    const decisionId=addNode(`آیا current ≤ ${analysis.end}?`,'decision','بررسی پایان حلقه',`current <= ${analysis.end}`);
    const addId=addNode('جمع عدد فعلی','proc','اضافه کردن عدد فعلی به sum','sum += current;');
    const incId=addNode('افزایش عدد فعلی','proc','افزایش current','current += 1;');
    const outputId=addNode('نمایش مجموع','proc','نمایش نتیجه sum','print(sum);');
    const endId=addNode('پایان','end','پایان الگوریتم','');

    edges.push({from:startId,to:initId},{from:initId,to:decisionId},{from:decisionId,to:addId,label:'بله'},
               {from:addId,to:incId},{from:incId,to:decisionId},{from:decisionId,to:outputId,label:'خیر'},{from:outputId,to:endId});
    return {nodes,edges};
  }

  if(analysis.type==='max'){
    const startId=addNode('شروع','start','شروع الگوریتم یافتن بزرگترین عدد','');
    const initId=addNode('مقداردهی اولیه','proc','تعریف max=لیست[0]','max=list[0];');
    const loopId=addNode('برای هر عدد در لیست','proc','چرخش روی هر عدد','for num in list:');
    const decisionId=addNode('اگر عدد فعلی > max؟','decision','بررسی بزرگتر بودن عدد','if num > max:');
    const assignId=addNode('max = عدد فعلی','proc','به روزرسانی max','max=num;');
    const endId=addNode('پایان','end','پایان الگوریتم','');

    edges.push({from:startId,to:initId},{from:initId,to:loopId},{from:loopId,to:decisionId},
               {from:decisionId,to:assignId,label:'بله'},{from:assignId,to:loopId},{from:decisionId,to:endId,label:'خیر'});
    return {nodes,edges};
  }

  if(analysis.type==='factorial'){
    const startId=addNode('شروع','start','شروع الگوریتم فاکتوریل','');
    const initId=addNode('مقداردهی اولیه','proc','تعریف result و n','result=1; n=input_number;');
    const decisionId=addNode('آیا n > 1؟','decision','بررسی پایان حلقه','n>1');
    const multId=addNode('ضرب در result','proc','result=result*n','result *= n;');
    const decId=addNode('کاهش n','proc','کاهش n','n -= 1;');
    const outputId=addNode('نمایش result','proc','نمایش نتیجه','print(result);');
    const endId=addNode('پایان','end','پایان الگوریتم','');

    edges.push({from:startId,to:initId},{from:initId,to:decisionId},{from:decisionId,to:multId,label:'بله'},
               {from:multId,to:decId},{from:decId,to:decisionId},{from:decisionId,to:outputId,label:'خیر'},{from:outputId,to:endId});
    return {nodes,edges};
  }

  const startId=addNode('شروع','start','شروع الگوریتم','');
  const procId=addNode('پردازش اصلی','proc','اجرای الگوریتم مسئله','// کد مربوط به مسئله');
  const endId=addNode('پایان','end','پایان الگوریتم','');
  edges.push({from:startId,to:procId},{from:procId,to:endId});
  return {nodes,edges};
}

/* ====== layout عمودی ====== */
function layoutGraph(graph){
  const positions={};
  let y=60;
  graph.nodes.forEach((n,idx)=>{
    let x=450;
    if(n.type==='decision') x = idx%2===0? 310 : 590;
    positions[n.id]={x,y};
    y+=110;
  });
  return positions;
}

/* ====== render SVG ====== */
function render(graph, positions, svgEl){
  while(svgEl.firstChild) svgEl.removeChild(svgEl);
  const ns='http://www.w3.org/2000/svg';
  const el=(t,a={})=>{const e=document.createElementNS(ns,t);for(const k in a)e.setAttribute(k,a[k]);return e;}
  const defs=el('defs'); svgEl.appendChild(defs);
  const marker=el('marker',{id:'arrow', markerWidth:10, markerHeight:10, refX:8, refY:5, orient:'auto', markerUnits:'strokeWidth'});
  marker.appendChild(el('path',{d:'M0 0 L10 5 L0 10 z',fill:'var(--arrow)'})); defs.appendChild(marker);

  graph.edges.forEach(e=>{
    const p1=positions[e.from], p2=positions[e.to];
    const startX=p1.x,startY=p1.y+30,endX=p2.x,endY=p2.y-30,midY=(startY+endY)/2;
    const pathD=`M ${startX} ${startY} C ${startX} ${midY} ${endX} ${midY} ${endX} ${endY}`;
    const pathEl=el('path',{d:pathD,stroke:'var(--arrow)','stroke-width':1.6,fill:'none','marker-end':'url(#arrow)'});
    svgEl.appendChild(pathEl);
    if(e.label){const tEl=el('text',{x:(startX+endX)/2,y:midY-8,'text-anchor':'middle'});tEl.textContent=e.label;svgEl.appendChild(tEl);}
  });

  graph.nodes.forEach(n=>{
    const p=positions[n.id]; const g=el('g',{'data-id':n.id});
    if(n.type==='start'){g.appendChild(el('rect',{x:p.x-110,y:p.y-22,width:220,height:44,rx:22,fill:'var(--start)'}));}
    else if(n.type==='end'){g.appendChild(el('rect',{x:p.x-110,y:p.y-22,width:220,height:44,rx:22,fill:'var(--end)'}));}
    else if(n.type==='decision'){const sX=110,sY=34;const pts=`${p.x},${p.y-sY} ${p.x+sX},${p.y} ${p.x},${p.y+sY} ${p.x-sX},${p.y}`;g.appendChild(el('polygon',{points:pts,fill:'var(--dec)'}));}
    else{g.appendChild(el('rect',{x:p.x-140,y:p.y-24,width:280,height:48,rx:8,fill:'var(--proc)'}));}

    const lines=n.text.match(/.{1,28}/g)||[n.text];
    lines.forEach((ln,i)=>{
      const tx=el('text',{x:p.x,y:p.y-((lines.length-1)*8)+i*16,'text-anchor':'middle'});
      tx.textContent=ln; g.appendChild(tx);
    });
    svgEl.appendChild(g);
  });
}

/* ====== UI ====== */
const genBtn=document.getElementById('generate'), problemEl=document.getElementById('problem'),
svgEl=document.getElementById('flowSvg'), explainEl=document.getElementById('explain');

genBtn.addEventListener('click',()=>{
  const problem=problemEl.value.trim(); if(!problem){alert('لطفاً مسئله را وارد کنید'); return;}
  const graph=buildGraph(problem);
  const pos=layoutGraph(graph);
  render(graph,pos,svgEl);

  const expl=graph.nodes.map(n=>`- [${n.id}] "${n.text}"\n  توضیح: ${n.explain}\n  کد: ${n.code}`).join('\n\n');
  explainEl.textContent=expl;
});

/* ====== Export SVG/PNG ====== */
document.getElementById('exportSvg').addEventListener('click',()=>{
  const serializer=new XMLSerializer(); const str=serializer.serializeToString(svgEl);
  const blob=new Blob([str],{type:'image/svg+xml'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='flowchart.svg'; document.body.appendChild(a);a.click();a.remove();
});
document.getElementById('exportPng').addEventListener('click',()=>{
  const serializer=new XMLSerializer(); const str=serializer.serializeToString(svgEl); const img=new Image();
  const svgBlob=new Blob([str],{type:'image/svg+xml'}); const url=URL.createObjectURL(svgBlob);
  img.onload=function(){const canvas=document.createElement('canvas');canvas.width=900;canvas.height=1200;
  const ctx=canvas.getContext('2d'); ctx.fillStyle='#02121a'; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height);
  canvas.toBlob(function(blob){const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='flowchart.png';document.body.appendChild(a);a.click();a.remove();},'image/png'); URL.revokeObjectURL(url);};
  img.src=url;
});
</script>

</body>
</html>
